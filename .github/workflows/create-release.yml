name: create tag

on:
  push:
    branches:
      - "main"

jobs:
  extract-version:
    name: Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract-version.outputs.version }}
    steps:
      - uses: actions/checkout@v3

      - name: Extract version
        id: extract-version
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          VERSION=$(echo -e $COMMIT_MSG | perl -pe 's/.*\/([0-9]+\.[0-9]+\.[0-9]+).*/$1/g;')
          echo "::set-output name=version::${VERSION}"

      - name: output
        run: |
          echo "ðŸ˜€"
          echo ${{ steps.extract-version.outputs.version }}
          echo "ðŸ˜€"

  create-tag:
    name: Create tag
    runs-on: ubuntu-latest
    needs: extract-version
    steps:
      - uses: actions/checkout@v3

      - name: Git config
        run: |
          git remote set-url origin https://github-actions:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Create tag
        run: |
          git tag v${{ needs.extract-version.outputs.version }}
          git push origin v${{ needs.extract-version.outputs.version }}

  create-release-page:
    name: Create Release
    runs-on: ubuntu-latest
    needs:
      - extract-version
      - create-tag
    steps:
      - uses: actions/checkout@v3

      - name: Extract release page body
        id: extract-body
        run: |
          RELEASE_NOTE=$(cat release.txt)
          RELEASE_NOTE="${RELEASE_NOTE//'%'/'%25'}"
          RELEASE_NOTE="${RELEASE_NOTE//$'\n'/'%0A'}"
          RELEASE_NOTE="${RELEASE_NOTE//$'\r'/'%0D'}" 
          echo "::set-output name=body::${RELEASE_NOTE}"

      - name: output
        run: |
          echo "${{ steps.extract-body.outputs.body }}"

      - name: Create release
        run: |
          gh release create v${{ needs.extract-version.outputs.version }} -n ${{ steps.extract-body.outputs.body }} -t "ãƒªãƒªãƒ¼ã‚¹ ${{ needs.extract-version.outputs.version }}"

      # - name: Create release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #   with:
      #     tag_name: v${{ needs.extract-version.outputs.version }}
      #     release_name: ãƒªãƒªãƒ¼ã‚¹ ${{ needs.extract-version.outputs.version }}
      #     body: |
      #       ${{ steps.extract-body.outputs.body }}
      #     draft: false
      #     prerelease: false
